<!DOCTYPE html>
<html>
	<head>
	<meta charset="utf-8">
	<!-- Bootstrap core CSS -->
    <link href="{{ url_for('static', filename='css/bootstrap.min.css') }}" rel="stylesheet">
    <link href="{{ url_for('static', filename='css/bootstrap-table.min.css') }}" rel="stylesheet">
    <!-- JavaScript -->
    <script src="static/js/jquery.min.js"></script>
    <script src="static/js/bootstrap.min.js"></script>
    <script src="static/js/bootstrap-table.min.js"></script>
    <!-- Own JavaScript -->
    <!-- <script src="static/js/ownjs/retire.js"></script> -->
	</head>
<body>
	<div class="container">
  	<form action='/retire' id="retireForm" method="post">
  		<!-- Example single danger button -->
		<div class="btn-group">
		<button id="myDropdown" type="button" class="btn btn-danger dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
			普通场
		</button>
		  	<div class="dropdown-menu" >
		    <a class="dropdown-item" href="#">普通场</a>
		    <a class="dropdown-item" href="#">癞子场</a>
		    <a class="dropdown-item" href="#">双癞子场</a>
		    <div class="dropdown-divider"></div>
		    <a class="dropdown-item" href="#">四人场</a>
		  	</div>
		</div>
        <table id="retireTable"></table>	
    	<input type="hidden" id="opform" name='opform' value={{request.form['opform']}}>
    	<button type="button" onclick="DoAllRetire();" class="btn btn-primary btn-lg">全部退休</button>
  	</form>
  	<script>
		// 更新单元格内容
		function UpdateTableCell(row, field, val){
			// 更新表格列"option"展示变为按钮
		    $('#retireTable').bootstrapTable('updateCell', {
                index: row,
                field: field,
                value: val,
            });			
		};
		
		function operateFormatter(value, row, index) {
        	return ['<button type="button" class="btn btn-primary">退休操作</button>'].join('');  	
    	};
		
		window.operateEvents = {
	        'click .btn': function (e, value, row, index) {
	            alert('You click like action, row: ' + JSON.stringify(row));
	            // 根据表格内容提交上传，上传json内容
				$('#opform').val(JSON.stringify(row));
				$('#retireForm').submit();
		    	ev.preventDefault();
	        },
	    };
		
		// 所有场次退休操作
		function DoAllRetire() {
			var tbldata = $('#retireTable').bootstrapTable('getData');
			var rows = tbldata.length;
			// 删除无用数据			
			for(var i = 0; i < rows; i++)
			{
				delete tbldata[i]['option'];
				// console.log(JSON.stringify(tbldata[i]));								
			}
			// 根据表格内容提交上传，上传json内容
			$('#opform').val(JSON.stringify(tbldata));
		    $('#retireForm').submit();
		};
		
		function GetIdSelections() {
	        return $.map($('#retireTable').bootstrapTable('getSelections'), function (row) {
	            return row.id;
	        });
	    }
		
		// 单个场次退休操作
		function DoRetire(ev) {
			var ids = GetIdSelections();			
			// var idx = $.map($('#retireTable').bootstrapTable('getSelections'), function(row){
				// return row.id;
			// });
			// var currow = $('#retireTable').bootstrapTable('getSelections');
			var alldata = $('#retireTable').bootstrapTable('getData');
			var rows = alldata.length;
			// 删除无用数据			
			for(var i = 0; i < rows; i++)
			{
				delete alldata[i]['option'];
				// console.log(JSON.stringify(tbldata[i]));								
			}
			// 根据表格内容提交上传，上传json内容
			$('#opform').val(JSON.stringify(alldata));
		    $('#retireForm').submit();
		    ev.preventDefault();
		};
		
		// 下拉框变化
		// 所有下拉框执行同一个事件回调函数,class=".dropdown-item"
		$(".dropdown-item").click(function(e) {		
			// document.getElementById('myDropdown').textContent = e.target.text;
			$('#myDropdown').textContent = e.target.text;
			// 提交表单获取场次信息key:levelswitch
			var op = JSON.stringify({'levelswitch':e.target.text});	
			$('#opform').val(op);
		    $('#retireForm').submit();
			e.preventDefault();
		});
		
		// 表格展示
		$(function InitTable() {
			// 引用html变量changci
			var points = JSON.parse('{{ changci|safe }}');
			// 重新加载场次信息
		    $('#retireTable').bootstrapTable({
		        data: points,
		        columns: [
		        		{
	                        field: 'host',
	                        title: '域名',
	                        align: 'center',
	                    },
	                    {
	                        field: 'level',
	                        title: 'Level',
	                        align: 'center',
                    	},
                    	{
	                        field: 'playnum',
	                        title: '在玩人数',
	                        align: 'center',
	                    },
	                    {
	                        field: 'option',
	                        title: '操作',
	                        align: 'center',
	                        formatter: operateFormatter,
	                        events: operateEvents,
	                    }]
		    });
		    // AddTableOption();
		});
	</script>
	</div>
</body>
</html>